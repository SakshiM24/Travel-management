{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

</head>
<body class="bg-gray-100">

  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 text-white p-6">
      <h2 class="text-xl font-semibold mb-6">Transport Admin</h2>
      <nav class="flex flex-col gap-2">
        <a href="#enroll-section" class="px-3 py-2 rounded hover:bg-gray-700 flex items-center gap-3"><i class="fa fa-user-plus"></i> Enrollment</a>
        <a href="#exit-section" class="px-3 py-2 rounded hover:bg-gray-700 flex items-center gap-3"><i class="fa fa-sign-out-alt"></i> Exit</a>
        <a href="#buses-section" class="px-3 py-2 rounded hover:bg-gray-700 flex items-center gap-3"><i class="fa fa-bus"></i> Buses</a>
        <a href="#logs-section" class="px-3 py-2 rounded hover:bg-gray-700 flex items-center gap-3"><i class="fa fa-file-alt"></i> Logs</a>

        <a href="{% url 'admin_logout' %}" class="mt-6 bg-red-600 px-3 py-2 rounded text-center hover:bg-red-700">Logout</a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-8">
      <header class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Admin Dashboard</h1>
        <div>
          {% if messages %}
            <div class="space-x-2">
              {% for message in messages %}
                <span class="px-4 py-1 rounded {{ message.tags }} bg-white/80 text-sm">{{ message }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </header>

     <!-- ENROLLMENT -->
<section id="enroll-section" class="mb-10">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-lg font-semibold">Enrollment Requests</h2>

    <!-- search -->
    <form method="get" class="flex gap-2">
      <input type="text" name="enroll_search" placeholder="Search name or emp id"
             value="{{ request.GET.enroll_search|default:'' }}"
             class="px-3 py-2 border rounded" />
      <select name="enroll_role" class="px-3 py-2 border rounded">
        <option value="">All roles</option>
        <option value="Employee" {% if request.GET.enroll_role == 'Employee' %}selected{% endif %}>Employee</option>
        <option value="Intern" {% if request.GET.enroll_role == 'Intern' %}selected{% endif %}>Intern</option>
      </select>
      <button type="submit" class="bg-blue-600 text-white px-3 py-2 rounded">Search</button>
    </form>
  </div>

  <div class="bg-white shadow rounded-lg overflow-hidden">
    <table class="min-w-full">
      <thead class="bg-blue-100">
        <tr>
          <th class="text-left px-4 py-3">Name</th>
          <th class="text-left px-4 py-3">Entity</th>
          <th class="text-left px-4 py-3">Role</th>
          <th class="text-left px-4 py-3">Emp ID</th>
          <th class="text-left px-4 py-3">Applied</th>
          <th class="text-left px-4 py-3">Status</th>
          <th class="px-4 py-3">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in enrollment_requests %}
        <tr class="border-t enroll-row" data-id="{{ r.id }}">
          <td class="px-4 py-3">{{ r.name }}</td>
          <td class="px-4 py-3">{{ r.entity }}</td>
          <td class="px-4 py-3">{{ r.role }}</td>
          <td class="px-4 py-3">{{ r.emp_id|default:'—' }}</td>
          <td class="px-4 py-3 text-sm text-gray-500">{{ r.applied_at|date:"d M Y H:i" }}</td>
          <td class="px-4 py-3">
            {% if r.status == 'Pending' %}
              <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded">{{ r.status }}</span>
            {% elif r.status == 'Accepted' %}
              <span class="px-2 py-1 bg-green-100 text-green-800 rounded">{{ r.status }}</span>
            {% else %}
              <span class="px-2 py-1 bg-red-100 text-red-800 rounded">{{ r.status }}</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 flex gap-2">
            <button data-status="Accepted" class="action-btn px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Accept</button>
            <button data-status="Rejected" class="action-btn px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">Reject</button>
           
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="7" class="p-4 text-center text-gray-500">No enrollment requests</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<!-- ✅ Add this CSS + JS at bottom -->
<style>
  .disabled-btn {
    opacity: 0.5;
    pointer-events: none;
  }
  .fade-out {
    opacity: 0;
    transition: opacity 0.4s ease-out;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const buttons = document.querySelectorAll(".action-btn");

  buttons.forEach(button => {
    button.addEventListener("click", function () {
      const row = this.closest(".enroll-row");
      const enrollmentId = row.getAttribute("data-id");
      const status = this.getAttribute("data-status");

      if (confirm(`Are you sure you want to mark this as ${status}?`)) {
        // Disable other buttons
        row.querySelectorAll(".action-btn").forEach(btn => btn.classList.add("disabled-btn"));

        // Send POST request using fetch
        fetch(`/enrollment/update/${enrollmentId}/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: new URLSearchParams({status: status})
        })
        .then(res => {
          if (res.ok) {
            // Smoothly fade out the row
            row.classList.add("fade-out");
            setTimeout(() => row.remove(), 400);
          } else {
            alert("Something went wrong while updating.");
          }
        })
        .catch(err => {
          console.error(err);
          alert("Network error.");
        });
      }
    });
  });
});
</script>


      <!-- EXIT -->
<section id="exit-section" class="mb-10">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-lg font-semibold">Exit Requests</h2>

    <!-- search -->
    <form method="get" class="flex gap-2">
      <input type="text" name="exit_search" placeholder="Search name or emp id"
             value="{{ request.GET.exit_search|default:'' }}"
             class="px-3 py-2 border rounded" />
      <input type="text" name="exit_role" placeholder="department"
             value="{{ request.GET.exit_role|default:'' }}"
             class="px-3 py-2 border rounded" />
      <button type="submit" class="bg-blue-600 text-white px-3 py-2 rounded">Search</button>
    </form>
  </div>

  <div class="bg-white shadow rounded-lg overflow-hidden">
    <table class="min-w-full">
      <thead class="bg-blue-100">
        <tr>
          <th class="text-left px-4 py-3">Name</th>
          <th class="text-left px-4 py-3">Entity</th>
          <th class="text-left px-4 py-3">Department</th>
          <th class="text-left px-4 py-3">Bus No</th>
          <th class="text-left px-4 py-3">Applied</th>
          <th class="text-left px-4 py-3">Status</th>
          <th class="px-4 py-3">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in exit_requests %}
        <tr class="border-t" data-exit-row>
          <td class="px-4 py-3">{{ r.employee_name }}</td>
          <td class="px-4 py-3">{{ r.entity }}</td>
          <td class="px-4 py-3">{{ r.department }}</td>
          <td class="px-4 py-3">{{ r.bus_no|default:'—' }}</td>
          <td class="px-4 py-3 text-sm text-gray-500">{{ r.applied_at|date:"d M Y H:i" }}</td>
          <td class="px-4 py-3">
            {% if r.status == 'Pending' %}
              <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded">{{ r.status }}</span>
            {% elif r.status == 'Accepted' %}
              <span class="px-2 py-1 bg-green-100 text-green-800 rounded">{{ r.status }}</span>
            {% else %}
              <span class="px-2 py-1 bg-red-100 text-red-800 rounded">{{ r.status }}</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 flex gap-2">
            <form method="post" action="{% url 'update_exit_status' r.id %}" onsubmit="return handleExitAction(event, this)">
              {% csrf_token %}
              <input type="hidden" name="status" value="Accepted" />
              <button class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Accept</button>
            </form>

            <form method="post" action="{% url 'update_exit_status' r.id %}" onsubmit="return handleExitAction(event, this)">
              {% csrf_token %}
              <input type="hidden" name="status" value="Rejected" />
              <button class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">Reject</button>
            </form>

            
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="7" class="p-4 text-center text-gray-500">No exit requests</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<script>
function handleExitAction(event, form) {
  event.preventDefault();
  const confirmed = confirm("Are you sure?");
  if (!confirmed) return false;

  const row = form.closest("[data-exit-row]");
  const buttons = row.querySelectorAll("button");
  buttons.forEach(btn => btn.disabled = true);
  row.style.opacity = "0.5";

  // submit the form to backend
  fetch(form.action, {
    method: "POST",
    body: new FormData(form),
  })
  .then(res => {
    if (res.ok) {
      row.style.transition = "opacity 0.3s ease";
      setTimeout(() => row.remove(), 400);
    }
  });
  return false;
}
</script>

    <!-- ✅ Buses Section -->
     <div id="edit-form-container"></div>

     <section id="buses-section" class="mb-10">
    <div class="bg-white p-6 rounded-2xl shadow-md mb-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-700">Bus Management</h2>
            <button onclick="openModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">+ Add Bus</button>
        </div>

        <table class="w-full border border-gray-200 rounded-lg text-center">
            <thead class="bg-blue-100">
                <tr>
                    <th class="p-3">Bus No</th>
                    <th class="p-3">Stop</th>
                    <th class="p-3">Pickup</th>
                    <th class="p-3">Drop</th>
                    <th class="p-3">Status</th>
                    <th class="p-3">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for bus in buses %}
                <tr class="border-t hover:bg-gray-50">
                    <td class="p-3">{{ bus.bus_no }}</td>
                    <td class="p-3">{{ bus.stop }}</td>
                    <td class="p-3">{{ bus.pickup_time }}</td>
                    <td class="p-3">{{ bus.drop_time }}</td>
                    <td class="p-3">
                        {% if bus.status == "Active" %}
                            <span class="bg-green-200 text-green-800 px-3 py-1 rounded-full">Active</span>
                        {% else %}
                            <span class="bg-red-200 text-red-800 px-3 py-1 rounded-full">Inactive</span>
                        {% endif %}
                    </td>
                    <td class="p-3 px-4 py-3 flex gap-2">

                      <!-- Edit and Delete buttons can be added here -->
                      <form action="{% url 'delete_bus' bus.id %}" method="post" style="display:inline;">
                        {% csrf_token %}
                     <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">Delete</button>
                    </form>
                   <form method ="post" action="{% url 'edit_bus' bus.id %}">
                        {% csrf_token %}
                 <button Type="button" onclick="openEditBusModal('{{ bus.id }}', '{{ bus.bus_no }}', '{{ bus.stop }}', '{{ bus.pickup_time }}', '{{ bus.drop_time }}', '{{ bus.status }}')"
               class="bg-yellow-500 text-white px-3 py-1 rounded"> Edit
               </button>
              </form>
            </td>
            {% empty %}
            <tr>
                <td colspan="5" class="p-3 text-gray-500">No buses added yet.</td>
            </tr>
            {% endfor %}
            </tbody>
            </table>
            </div>
            </section>
                        
                        
       


  

                             
    








                

    <!-- ✅ Add Bus Modal -->
    <div id="busModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-lg w-96 p-6">
            <h3 class="text-lg font-bold mb-4 text-blue-700">Add New Bus</h3>

            <form method="POST" action="{% url 'admin_dashboard' %}">
                {% csrf_token %}
                <div class="mb-3">
                    <label class="block text-gray-600">Bus Number</label>
                    <input type="text" name="bus_no" required class="w-full p-2 border rounded-lg">
                </div>

                <div class="mb-3">
                    <label class="block text-gray-600">Stop</label>
                    <input type="text" name="stop" required class="w-full p-2 border rounded-lg">
                </div>

                <div class="mb-3">
                    <label class="block text-gray-600">Pickup Time</label>
                    <input type="time" name="pickup_time" class="w-full p-2 border rounded-lg">
                </div>

                <div class="mb-3">
                    <label class="block text-gray-600">Drop Time</label>
                    <input type="time" name="drop_time" class="w-full p-2 border rounded-lg">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-600">Status</label>
                    <select name="status" class="w-full p-2 border rounded-lg">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal()" class="bg-gray-300 px-4 py-2 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add</button>
                </div>
            </form>
        </div>
    </div>

</div>

<!-- ✅ Edit Bus Modal -->
<div id="editBusModal" class="fixed inset-0 hidden bg-black bg-opacity-40 flex justify-center items-center">
  <div class="bg-white rounded-lg p-6 w-96">
    <h2 class="text-xl font-semibold mb-4">Edit Bus</h2>

    <!-- ✅ The form's action will be updated dynamically -->
    <form id="editBusForm" method="POST">
      {% csrf_token %}

      <div class="mb-3">
        <label class="block text-gray-600">Bus Number</label>
        <input type="text" id="editBusNo" name="bus_no" required class="w-full p-2 border rounded">
      </div>

      <div class="mb-3">
        <label class="block text-gray-600">Stop</label>
        <input type="text" id="editStop" name="stop" required class="w-full p-2 border rounded">
      </div>

      <div class="mb-3">
        <label class="block text-gray-600">Pickup Time</label>
        <input type="time" id="editPickupTime" name="pickup_time" class="w-full p-2 border rounded">
      </div>

      <div class="mb-3">
        <label class="block text-gray-600">Drop Time</label>
        <input type="time" id="editDropTime" name="drop_time" class="w-full p-2 border rounded">
      </div>

      <div class="mb-4">
        <label class="block text-gray-600">Status</label>
        <select id="editStatus" name="status" class="w-full p-2 border rounded">
          <option value="Active">Active</option>
          <option value="Inactive">Inactive</option>
        </select>
      </div>

      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeEditModal()" class="bg-gray-300 px-4 py-2 rounded-lg">Cancel</button>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Update</button>
      </div>
    </form>
  </div>
</div>




<!-- ✅ Modal JS -->
<script>
function openModal() {
    document.getElementById("busModal").classList.remove("hidden");
}
function closeModal() {
    document.getElementById("busModal").classList.add("hidden");
}
</script>

<script>
function openEditBusModal(id, bus_no, stop, pickup, drop, status) {
  const modal = document.getElementById("editBusModal");
  modal.classList.remove("hidden");

  // Fill form fields
  document.getElementById("editBusNo").value = bus_no;
  document.getElementById("editStop").value = stop;
  document.getElementById("editPickupTime").value = pickup;
  document.getElementById("editDropTime").value = drop;
  document.getElementById("editStatus").value = status;

  // Set the form action dynamically
  document.getElementById("editBusForm").action = `/admin/edit-bus/${id}/`;
}

function closeEditModal() {
  document.getElementById("editBusModal").classList.add("hidden");
}
</script>




